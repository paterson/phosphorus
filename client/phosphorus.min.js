Phosphorus={},Phosphorus.baseUrl="http://127.0.0.1",Phosphorus.socket=io.connect(Phosphorus.baseUrl),Phosphorus.get=function(a,b){if(Phosphorus.watched().contains(a.toString()))return b(JSON.parse(localStorage[a.toString()]));var c="/get",d={key:a};ajax(c,d,function(c){localStorage[a.toString()]=JSON.stringify(c),b(c)}),Phosphorus.subscribe(a)},Phosphorus.set=function(a,b){var c="/set",d={key:a,value:b};return ajax(c,d),Phosphorus.subscribe(a),b},Phosphorus.fetch=function(a,b,c){Phosphorus.get(a,function(d){return d?c(d):(Phosphorus.set(a,b),c(b))})},Phosphorus.listen=function(a,b){document.addEventListener("phosphorus-"+a,function(a){b.apply(null,[a.detail])})},Phosphorus.subscribe=function(a){Phosphorus.addToWatched(a),Phosphorus.socket.$events&&Phosphorus.socket.$events[a.toString()]||Phosphorus.socket.on(a.toString(),function(b){var c=document.createEvent("Event");c.initEvent("phosphorus-"+a.toString(),!0,!1),c.detail=b,document.dispatchEvent(c),localStorage[a.toString()]=JSON.stringify(b)})},Phosphorus.unsubscribe=function(a,b){Phosphorus.socket.removeAllListeners(a.toString()),b&&b()},Phosphorus.restart=function(){if(localStorage.watched){watched=Phosphorus.watched();for(var a=0;a<watched.length;a++)localStorage.removeItem(watched[a]);localStorage.removeItem("watched")}return""},Phosphorus.addToWatched=function(a){watched=Phosphorus.watched(),watched.push(a.toString()),localStorage.watched=JSON.stringify(watched)},Phosphorus.watched=function(){return localStorage.watched?JSON.parse(localStorage.watched):[]},Array.prototype.contains=function(a){for(var b=this.length;b--;)if(this[b]===a)return!0;return!1};var ajax=function(a,b,c){$.post(Phosphorus.baseUrl+a,b,function(a){c&&c(a)})};window.onbeforeunload=Phosphorus.restart(),window.Phosphorus=Phosphorus;
